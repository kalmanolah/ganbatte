(function(f){function h(){if(typeof _browser_scrollbar_width!="undefined"){return _browser_scrollbar_width}var x=f('<p style="width:100%;height:200px;"></p>');var u=f('<div style="position:absolute;top:0;left:0;visibility:hidden;width:200px;height:150px;overflow:hidden;"></div>');x.appendTo(u);u.appendTo("body");var v=x[0];var w=u[0];var t=v.offsetWidth;w.style.overflow="scroll";var s=v.offsetWidth;if(t==s){s=w.clientWidth}document.body.removeChild(w);_browser_scrollbar_width=(t-s);return _browser_scrollbar_width}function o(s,u){var t=_.template(f(s+"-template").html(),u);f(s).html(t)}function n(s,t){return f.cookie("ganbatte_"+s)||t}function c(s,u){var t=n(s,u);if(typeof t=="string"){return t=="true"}return t}function r(s,t){f.cookie("ganbatte_"+s,t,{expires:999,path:"/"})}function a(s){f('.sidebar-page[data-page-id="'+s.get("id")+'"]').addClass("active").siblings().removeClass("active");_selected_page=s}function g(){var s=_selected_page.get("id");var t=_page_list.models.length==s+1?0:s+1;a(_page_list.models[t]);_page_view.render()}function d(){f.getJSON(app.data_path,function(s){f.each(_item_list.models,function(t,u){u.resetState()});f.each(s,function(w,u){var C=_job_list.where({name:u.name});var A=u.lastBuild&&u.lastBuild.building;u.color=u.color.replace("_anime","");u.building=A;if(u.color=="aborted"){u.building=false}var v={blue:"success",disabled:"disabled",red:"failed",grey:"pending",yellow:"unstable",aborted:"failed"};var x=v[u.color];u.status=x;var z={success:"success",disabled:"disabled",failed:"danger",unstable:"warning",pending:"info"};var B=z[u.status];u.label=B;var t=null;if(u.building){for(var y=0;y<u.lastBuild.actions.length;y++){if(u.lastBuild.actions[y].causes){t=u.lastBuild.actions[y].causes[0];break}}}u.cause=t;f.each(C,function(D,F){F.set(u);if(u.building&&typeof F.get("trigger")!="undefined"){if(u.cause.upstreamProject&&u.cause.upstreamProject!=F.get("trigger")){F.set({building:false});u.building=false}}var E=F.get("item");if(E.get("status")){if(E.get("status")!="failed"){if((E.get("status")=="disabled")||(E.get("status")=="pending"&&u.status!="disabled")||u.status=="failed"){E.set({status:u.status})}}}else{E.set({status:u.status})}if(!E.get("building")&&u.building){E.set({building:u.building})}})});_page_view.renderBase()})}var l=Backbone.Model.extend({defaults:{building:false,status:"disabled"}});var b=Backbone.Model.extend({resetState:function(){this.set({status:null,building:false})}});var i=Backbone.Model.extend();var q=Backbone.Collection.extend();var m=Backbone.Collection.extend({getOrdered:function(){return f.merge(f.merge(f.merge(f.merge(f.merge(f.merge(f.merge(this.where({status:"failed",building:true}),this.where({status:"failed",building:false})),this.where({status:"success",building:true})),this.where({status:"pending",building:true})),this.where({status:"disabled",building:true})),this.where({status:"success",building:false})),this.where({status:"pending",building:false})),this.where({status:"disabled",building:false}))}});var p=Backbone.View.extend({el:".content-inner",render:function(){this.$el.fadeOut(function(){_page_view.renderBase();_page_view.$el.fadeIn()})},renderBase:function(){o(".content-inner",{page:_selected_page})}});var e=Backbone.Collection.extend();var k=Backbone.Model.extend({defaults:function(){return{progress:app.progress_override||c("progress",false),progress_interval:null,refresh:app.refresh_override||c("refresh",false),refresh_interval:null,sidebar:c("sidebar",false)}},toggleBool:function(s){var t=!this.get(s);this.setBool(s,t)},setBool:function(s,t){this.set(s,t);r(s,t)}});var j=Backbone.View.extend({el:"body",initialize:function(){this.listenTo(this.model,"change:progress",this.renderSidebar);this.listenTo(this.model,"change:refresh",this.renderSidebar);this.listenTo(this.model,"change:sidebar",this.renderSidebar);this.renderSidebar();this.doProgress();this.doRefresh();f(window).on("resize",this.fixSidebarDimensions);d()},events:{"click .progress-toggle":"toggleProgress","click .refresh-toggle":"toggleRefresh","click .sidebar-toggle":"toggleSidebar","click .sidebar-page":"clickPage"},toggleProgress:function(){this.model.toggleBool("progress");this.doProgress()},doProgress:function(){if(this.model.get("progress")){this.model.set("progress_interval",setInterval(g,app.progress_interval*1000))}else{clearInterval(this.model.get("progress_interval"))}},toggleRefresh:function(){this.model.toggleBool("refresh");this.doRefresh()},doRefresh:function(){if(this.model.get("refresh")){this.model.set("refresh_interval",setInterval(d,app.refresh_interval*1000))}else{clearInterval(this.model.get("refresh_interval"))}},toggleSidebar:function(){this.model.toggleBool("sidebar")},clickPage:function(t){this.model.setBool("progress",false);this.doProgress();var s=f(t.currentTarget).data("page-id");var u=this.model.get("pages").models[s];a(u);_page_view.render()},fixSidebarDimensions:function(){var t=f(".sidebar-pages");var s=(f(window).height()-t.offset().top)+"px";t.css("height",s);var u="-"+h()+"px";t.css("margin-right",u)},renderSidebar:function(){o(".sidebar-header",{ganbatte:this.model});o(".sidebar-pages",{ganbatte:this.model});if(this.model.get("sidebar")){this.$el.removeClass("sidebar-shrunk")}else{this.$el.addClass("sidebar-shrunk")}this.fixSidebarDimensions()}});f(function(){BJSInstance=new BeyondJS();_job_list=new q();_item_list=new m();_page_list=new e();f.each(app.pages,function(v,w){var x=new i();var u=new m();f.each(w.items,function(z,B){var A=new b();var y=[];f.each(B.jobs,function(C,E){var D=new l(f.extend(E,{item:A}));_job_list.add(D);y.push(D)});A.set(f.extend(B,{jobs:y,page:x}));u.add(A);_item_list.add(A)});x.set(f.extend(w,{items:u,id:v}));_page_list.add(x)});_page_view=new p();_selected_page=_page_list.models[app.initial_page];var s=new k({pages:_page_list});var t=new j({model:s});a(_selected_page)})})(jQuery);